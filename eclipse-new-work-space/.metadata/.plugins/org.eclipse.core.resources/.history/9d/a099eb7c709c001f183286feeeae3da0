package com.transport.transport.service.impl;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.transport.transport.dto.DriverDTO;
import com.transport.transport.dto.VehicleDTO;
import com.transport.transport.entity.Booking;
import com.transport.transport.entity.Driver;
import com.transport.transport.entity.Vehicle;
import com.transport.transport.repository.BookingRepository;
import com.transport.transport.repository.DriverRepository;
import com.transport.transport.service.DriverService;

@Service
public class DriverServiceImpl implements DriverService{

	@Autowired
	private DriverRepository driverRepository;
	
	@Autowired
	private BookingRepository bookingRepository;
	
	@Override
	public void addDriver(DriverDTO driver) {
		Driver driverData = new Driver();
		driverData.setAddress(driver.getAddress());
		driverData.setCity(driver.getCity());
		driverData.setDob(driver.getDob());
		driverData.setEmail(driver.getEmail());
		driverData.setFirstname(driver.getAddress());
		driverData.setGender(driver.getGender());
		driverData.setLastname(driver.getLastname());
		driverData.setMobile(driver.getMobile());
		driverData.setPin(driver.getPin());
		driverData.setType(driver.getType());
		driverRepository.save(driverData);
	}
	@Override
	public List<DriverDTO> getDrivers() {
		return driverRepository.findAll().stream()
		        .map(driver -> new DriverDTO(driver.getId(), driver.getAddress(), driver.getCity(),
		        		driver.getEmail(),driver.getDob(),driver.getFirstname(),driver.getGender(),
		        		driver.getLastname(),driver.getMobile(),driver.getPin(),driver.getType()))
		        .collect(Collectors.toList());
		
	}
	
	@Override
    public DriverDTO getDriverDetail(Integer id) {
        Driver driver = driverRepository
                .findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "Invalid user Id:" + id));
        DriverDTO driverData = new DriverDTO(id, null, null, null, null, null, null, null, null, null,null);
        driverData.setAddress(driver.getAddress());
		driverData.setCity(driver.getCity());
		driverData.setDob(driver.getDob());
		driverData.setEmail(driver.getEmail());
		driverData.setFirstname(driver.getAddress());
		driverData.setGender(driver.getGender());
		driverData.setLastname(driver.getLastname());
		driverData.setMobile(driver.getMobile());
		driverData.setPin(driver.getPin());
		driverData.setId(driver.getId());
		driverData.setType(driver.getType());
        return driverData;
    }
	
	
	@Override
	public void updateDriver(Integer id, DriverDTO driver) {
		Driver driverData = driverRepository
        .findById(id)
        .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "Invalid user Id:" + id));
		driverData.setId(id);
		driverData.setAddress(driver.getAddress());
		driverData.setCity(driver.getCity());
		driverData.setDob(driver.getDob());
		driverData.setEmail(driver.getEmail());
		driverData.setFirstname(driver.getFirstname());
		driverData.setGender(driver.getGender());
		driverData.setLastname(driver.getLastname());
		driverData.setMobile(driver.getMobile());
		driverData.setPin(driver.getPin());
		driverData.setId(driver.getId());
		driverData.setType(driver.getType());
		driverRepository.save(driverData);
	}
	
	@Override
	public void deleteDriver(Integer id) {
		 Driver driver = driverRepository
	                .findById(id).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "Invalid user Id:" + id));

	        driverRepository.delete(driver);
	}
	@Override
	public List<DriverDTO> findAvailableDrivers(LocalDateTime startDate1, LocalDateTime endDate1, String type) {
		// TODO Auto-generated method stub
		  List<Driver> allDrivers = driverRepository.findByTypeContaining(type);
	        
	        List<DriverDTO> availableDrivers = new ArrayList<>();

	        for (Driver driver : allDrivers) {
	            // Check if this vehicle is booked during the given date range
	            List<Booking> bookings = bookingRepository.findBookingsForDriverInDateRange(driver.getId(), startDate1, endDate1);
	            DriverDTO driverData = new DriverDTO(null, type, type, type, type, type, type, type, type, type, type);
	            driverData.setId(driver.getId());
	    		driverData.setAddress(driver.getAddress());
	    		driverData.setCity(driver.getCity());
	    		driverData.setDob(driver.getDob());
	    		driverData.setEmail(driver.getEmail());
	    		driverData.setFirstname(driver.getFirstname());
	    		driverData.setGender(driver.getGender());
	    		driverData.setLastname(driver.getLastname());
	    		driverData.setMobile(driver.getMobile());
	    		driverData.setPin(driver.getPin());
	    		driverData.setId(driver.getId());
	    		driverData.setType(driver.getType());
	            // If no bookings found, the vehicle is available
	            if (bookings.isEmpty()) {
	            	availableDrivers.add(driverData);
	            }
	        }

	        return availableDrivers;
	}
}
